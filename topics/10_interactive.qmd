# Interactive Plots {background-color="#27ae60"}

```{r}
#| label: setup
#| include: false

library(ggplot2)
library(plotly)
library(crosstalk)
library(conflicted)
conflict_prefer("layout", "plotly")
theme_set(theme_bw())
```

## The Appeal of Interactivity

**Why use interactive plots?**

::: {.incremental}
- üñ±Ô∏è Hover to see exact values
- üîç Zoom and pan
- üëÅÔ∏è Toggle traces on/off
- üìä Great for exploration
- üéØ Excellent for presentations
:::


## Basic ggplotly Example

```{r}
#| label: interactive-example-create
#| echo: false
#| eval: true

library(ggplot2)
library(plotly)

# Create clean data for tooltips
mtcars_clean <- mtcars
mtcars_clean$Cylinders <- factor(mtcars$cyl)

# Create ggplot
p_example <- ggplot(mtcars_clean, aes(wt, mpg, color = Cylinders)) +
  geom_point(size = 3) +
  geom_smooth(method = "lm", se = FALSE) +
  scale_color_brewer(palette = "Set1") +
  theme_minimal() +
  labs(title = "Fuel Efficiency by Weight",
       x = "Weight (1000 lbs)",
       y = "Miles per Gallon",
       color = "Cylinders")
```

::: {.columns}
::: {.column width="45%"}
```{r}
#| label: interactive-example-code
#| echo: true
#| eval: false

library(ggplot2)
library(plotly)

# Create clean data for tooltips
mtcars_clean <- mtcars
mtcars_clean$Cylinders <- factor(mtcars$cyl)

# Create ggplot
p <- ggplot(mtcars_clean, aes(wt, mpg, color = Cylinders)) +
  geom_point(size = 3) +
  geom_smooth(method = "lm", se = FALSE) +
  scale_color_brewer(palette = "Set1") +
  theme_minimal() +
  labs(title = "Fuel Efficiency by Weight",
       x = "Weight (1000 lbs)",
       y = "Miles per Gallon",
       color = "Cylinders")
```

Try hovering over points!

- See exact values
- Toggle series on/off
- Zoom and pan
:::

::: {.column width="55%"}
```{r}
#| label: interactive-example
#| echo: true
#| eval: true
#| fig-width: 5.5
#| fig-height: 4.5

# Make interactive
ggplotly(p_example)
```
:::
:::

## Customizing Tooltips

```{r}
#| label: interactive-tooltips-create
#| echo: false
#| eval: true

# Control what appears on hover
mtcars_tooltips <- mtcars
mtcars_tooltips$Cylinders <- factor(mtcars$cyl)

p_tooltips <- ggplot(mtcars_tooltips, aes(wt, mpg, color = Cylinders,
                        text = paste("Car:", rownames(mtcars),
                                   "<br>HP:", hp))) +
  geom_point(size = 3) +
  theme_minimal()
```

::: {.columns}
::: {.column width="45%"}
```{r}
#| label: interactive-tooltips-code
#| echo: true
#| eval: false

# Control what appears on hover
mtcars_clean <- mtcars
mtcars_clean$Cylinders <- factor(mtcars$cyl)

p <- ggplot(mtcars_clean, aes(wt, mpg, color = Cylinders,
                        text = paste("Car:", rownames(mtcars),
                                   "<br>HP:", hp))) +
  geom_point(size = 3) +
  theme_minimal()
```

Now hover shows car name and horsepower!

Use the `text` aesthetic and `tooltip` parameter to customize what appears on hover.
:::

::: {.column width="55%"}
```{r}
#| label: interactive-tooltips
#| echo: true
#| eval: true
#| fig-width: 5.5
#| fig-height: 4.5

ggplotly(p_tooltips, tooltip = c("text", "x", "y"))
```
:::
:::

## The Saving Problem

::: {.callout-warning}
## Challenge

Interactive plots are **HTML widgets**, not static images!

Can't just save as PDF or PNG traditionally.
:::

## Solution: Save as HTML (Keep Interactivity)

```{r}
#| label: interactive-save-html-create
#| echo: false
#| eval: true

library(htmlwidgets)

# Create output directory if needed
dir.create("plots/10_interactive", recursive = TRUE, showWarnings = FALSE)

# Create a plot and make it interactive
mtcars_save <- mtcars
mtcars_save$Cylinders <- factor(mtcars$cyl)
p_save <- ggplot(mtcars_save, aes(wt, mpg, color = Cylinders)) +
  geom_point(size = 3) +
  theme_minimal()

p_interactive_save <- ggplotly(p_save)
```

```{r}
#| label: interactive-save-html
#| echo: true
#| eval: true

library(htmlwidgets)

# Create a plot and make it interactive
p_interactive <- ggplotly(p_save)

# Save as self-contained HTML
saveWidget(p_interactive_save,
           "plots/10_interactive/interactive_plot.html",
           selfcontained = TRUE)
```

**About `selfcontained` parameter:**

- `selfcontained = TRUE`: Bundles all JavaScript/CSS into one file
  - Perfect for emailing or sharing
  - No external dependencies needed
  - Larger file size

- `selfcontained = FALSE`: Creates separate library files
  - Smaller main HTML file
  - Requires folder structure to be maintained

**Uses:**

- Email the HTML file directly
- Upload to website
- Opens in any web browser!

## Quarto/Markdown Integration

In Quarto, ggplotly works seamlessly:

```{r}
#| label: quarto-example
#| echo: fenced
#| eval: false

library(plotly)
library(ggplot2)

# Create plot
p <- ggplot(mtcars, aes(wt, mpg)) + geom_point()

# Make it interactive
ggplotly(p)
```

Perfect for modern scientific reports!

## 3D Plots

::: {.columns}
::: {.column width="40%"}
```{r}
#| label: interactive-3d-code
#| echo: true
#| eval: false

# 3D scatter plot
mtcars_3d <- mtcars
mtcars_3d$Cylinders <- factor(mtcars$cyl)

plot_ly(mtcars_3d,
        x = ~wt, y = ~hp, z = ~mpg,
        color = ~Cylinders,
        type = "scatter3d",
        mode = "markers")
```
:::

::: {.column width="60%"}
```{r}
#| label: interactive-3d
#| echo: false
#| eval: true
#| out-width: 100%
#| out-height: 350px

# 3D scatter plot
mtcars_3d <- mtcars
mtcars_3d$Cylinders <- factor(mtcars$cyl)

plot_ly(mtcars_3d,
        x = ~wt, y = ~hp, z = ~mpg,
        color = ~Cylinders,
        type = "scatter3d",
        mode = "markers",
        width = 500,
        height = 350)
```

Rotate by clicking and dragging!

Great for exploring multivariate data in 3D space.
:::
:::



## Linked Plots with Crosstalk

```{r}
#| label: interactive-crosstalk-create
#| echo: false
#| eval: true

# Create shared data with rich tooltips
mtcars_shared <- mtcars
mtcars_shared$car_name <- rownames(mtcars)
mtcars_shared$Cylinders <- factor(mtcars$cyl)

# Create custom tooltip text
mtcars_shared$tooltip_text <- paste0(
  "<b>", mtcars_shared$car_name, "</b><br>",
  "Cylinders: ", mtcars_shared$cyl, "<br>",
  "Weight: ", round(mtcars_shared$wt, 2), " (1000 lbs)<br>",
  "HP: ", mtcars_shared$hp, "<br>",
  "MPG: ", mtcars_shared$mpg
)

shared_data <- SharedData$new(mtcars_shared, ~car_name)

# Create linked plots with custom tooltips
p1 <- plot_ly(shared_data, x = ~wt, y = ~mpg, color = ~Cylinders, type = 'scatter', mode = 'markers', text = ~tooltip_text, hoverinfo = 'text') %>%
  layout(showlegend = FALSE)

p2 <- plot_ly(shared_data, x = ~hp, y = ~mpg, color = ~Cylinders, type = 'scatter', mode = 'markers', text = ~tooltip_text, hoverinfo = 'text') %>%
  layout(showlegend = FALSE)
```

```{r}
#| label: interactive-crosstalk-code
#| echo: true
#| eval: false

# Create shared data
mtcars$car_name <- rownames(mtcars)
shared_data <- SharedData$new(mtcars, ~car_name)

# Create linked plots
p1 <- plot_ly(shared_data, x = ~wt, y = ~mpg, type = 'scatter', mode = 'markers')
p2 <- plot_ly(shared_data, x = ~hp, y = ~mpg, type = 'scatter', mode = 'markers')

# Display with filter on top
bscols(widths = 12, filter_checkbox("cyl", "Cylinders:", shared_data, ~cyl, inline = TRUE))
subplot(p1, p2, nrows = 1, shareY = TRUE)
```


::: {.columns}
::: {.column width="20%"}
```{r}
#| label: interactive-crosstalk-filter
#| echo: false
#| eval: true

# Display filter
filter_checkbox("cyl", "Cylinders:", shared_data, ~cyl, inline = FALSE)
```
:::

::: {.column width="80%"}
```{r}
#| label: interactive-crosstalk
#| echo: false
#| eval: true
#| fig-width: 8
#| fig-height: 3.2

# Display plots
subplot(p1, p2, nrows = 1, shareY = TRUE, titleX = TRUE, margin = 0.08) %>%
  layout(showlegend = FALSE, hovermode = "closest")
```
:::
:::

## Hybrid Approach: Both Versions

```{r}
#| label: interactive-hybrid
#| echo: true
#| eval: true

# Create output directory if needed
dir.create("plots/10_interactive", recursive = TRUE, showWarnings = FALSE)

# Create base plot
p_static <- ggplot(mtcars, aes(wt, mpg, color = factor(cyl))) +
  geom_point(size = 3) +
  theme_classic(base_size = 12)

# Static version for publication
ggsave("plots/10_interactive/figure1.pdf", p_static, width = 7, height = 5)

# Interactive version for supplement/website
p_interactive <- ggplotly(p_static)
saveWidget(p_interactive, "plots/10_interactive/figure1_interactive.html")

# Best of both worlds!
```

## Sharing Interactive Plots

**Options:**

1. **Email HTML file** (if selfcontained = TRUE)
2. **Upload to web server**
3. **GitHub Pages** (free hosting)
4. **Shiny app** (for more complex interactions)

## Limitations of ggplotly

**Not all ggplot2 features convert:**

- Some geoms don't translate well
- Complex annotations may be lost
- Custom themes partially supported
- Facets work but can be slow

**Test your conversion!**

## Alternative: ggiraph

```{r}
#| label: interactive-ggiraph-create
#| echo: false
#| eval: true

library(ggiraph)

# Create plot with interactive elements
mtcars_ggiraph <- mtcars
mtcars_ggiraph$car_name <- rownames(mtcars)
mtcars_ggiraph$Cylinders <- mtcars$cyl

# Create rich tooltips with multiple pieces of info
mtcars_ggiraph$tooltip_text <- paste0(
  "<b>", mtcars_ggiraph$car_name, "</b><br>",
  "Weight: ", round(mtcars_ggiraph$wt, 2), " (1000 lbs)<br>",
  "MPG: ", mtcars_ggiraph$mpg, "<br>",
  "HP: ", mtcars_ggiraph$hp, "<br>",
  "Cylinders: ", mtcars_ggiraph$cyl
)

p_ggiraph <- ggplot(mtcars_ggiraph, aes(wt, mpg,
                        tooltip = tooltip_text,
                        data_id = car_name)) +
  geom_point_interactive(aes(color = factor(Cylinders)), size = 3) +
  scale_color_brewer(palette = "Set1", name = "Cylinders") +
  theme_minimal()
```

::: {.columns}
::: {.column width="50%"}
```{r}
#| label: interactive-ggiraph-code
#| echo: true
#| eval: false

library(ggiraph)

# Create plot with interactive elements
mtcars$car_name <- rownames(mtcars)

# Create rich tooltips with HTML formatting
mtcars$tooltip_text <- paste0(
  "<b>", mtcars$car_name, "</b><br>",
  "Weight: ", round(mtcars$wt, 2), " (1000 lbs)<br>",
  "MPG: ", mtcars$mpg, "<br>",
  "HP: ", mtcars$hp, "<br>",
  "Cylinders: ", mtcars$cyl
)

p <- ggplot(mtcars, aes(wt, mpg,
                        tooltip = tooltip_text,
                        data_id = car_name)) +
  geom_point_interactive(aes(color = factor(cyl)), size = 3) +
  theme_minimal()
```
:::

::: {.column width="50%"}
```{r}
#| label: interactive-ggiraph
#| echo: true
#| eval: true
#| fig-width: 4
#| fig-height: 3

girafe(ggobj = p_ggiraph)
```

**ggiraph offers better ggplot2 compatibility:**

- Built specifically for ggplot2 (not a conversion layer)
- Preserves more complex themes and annotations
- Better control over tooltips and interactions
- Uses special `_interactive` geoms

Hover to see tooltips, click to select!
:::
:::

## Key Takeaways

::: {.callout-tip}
## Best Practices & Summary

**Core concepts:**

- Interactive plots are **HTML widgets**, not images
- Use `ggplotly()` to convert ggplot2 plots instantly
- Use `saveWidget()` with `selfcontained = TRUE` to save

**When to use what:**

- **Interactive:** exploration, presentations, HTML reports
- **Static:** publications, print, PDF reports

**Tips:**

1. **Create both versions** when possible
2. **Sample large datasets** to keep HTML file manageable
3. **Test thoroughly** - not all ggplot2 features convert
4. **Consider ggiraph** if ggplotly doesn't preserve your styling
5. **Use selfcontained = TRUE** for easy sharing
:::
