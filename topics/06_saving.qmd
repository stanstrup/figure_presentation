# Saving Plots in R {background-color="#34495e"}

## The Graphics Device System

**Every plot needs a "device"**

::: {.fragment}
Device = where R sends the graphics output (device = "the printer")

- Screen (RStudio viewer)
- PDF file
- SVG file
- PNG file
- JPEG file
- etc.
:::

## Old Way: Manual Device Management

```{r}
#| label: saving-old-way
#| echo: true
#| eval: false

pdf("myplot.pdf", width = 7, height = 5)
  plot(x, y)
dev.off()  # CRITICAL! Must close device
```

::: {.callout-note}
## dev.off() Works with ALL R Plots

The `dev.off()` approach works for:

- Base R plots (`plot()`, `hist()`, `barplot()`, etc.)
- ggplot2 plots
- Any R graphics output

**It's universal** - not limited to any specific plotting system!
:::

::: {.fragment}
**Problems with manual device management:**

- Easy to forget `dev.off()`
- Verbose
- Not intuitive
- Must manage device lifecycle manually
:::

## Modern Way: ggsave()

**For ggplot2 objects** (recommended!)

```{r}
#| label: saving-ggsave-basic
#| echo: true
#| eval: false

p <- ggplot(mtcars, aes(wt, mpg)) + geom_point()

# Saves last plot by default
ggsave("myplot.pdf")

# Better: explicit plot object
ggsave("myplot.pdf", plot = p, width = 6, height = 4)
```

No `dev.off()` needed! ✨

### Full Control

```{r}
#| label: saving-ggsave-full
#| echo: true
#| eval: false

ggsave(
  filename = "figure1.pdf",
  plot = my_plot,
  width = 7,
  height = 5,
  units = "in",     # or "cm", "mm"
  dpi = 300,        # for raster formats
  device = "pdf"    # or "png", "svg", "tiff"
)
```


## Converting PDF to High-Res PNG

**Why?** Keep vector source, generate raster as needed

### Using R (magick package)

```{r}
#| label: saving-magick
#| echo: true
#| eval: false

library(magick)

# Read PDF and convert
img <- image_read_pdf("plot.pdf", density = 300)
image_write(img, "plot.png", format = "png")
```


## Using magick for Conversion

```{r}
#| label: saving-magick-convert
#| echo: true
#| eval: false

library(magick)

# Convert PDF to 300 DPI PNG
img <- image_read_pdf("plot.pdf", density = 300)
image_write(img, "plot.png", format = "png", quality = 100)

# With better antialiasing (remove alpha channel)
img <- image_read_pdf("plot.pdf", density = 300)
img <- image_background(img, "white")  # Remove alpha
image_write(img, "plot.png", format = "png", quality = 100)

# Batch convert all PDFs in directory
pdf_files <- list.files(pattern = "\\.pdf$")
for (file in pdf_files) {
  img <- image_read_pdf(file, density = 300)
  img <- image_background(img, "white")
  out_file <- sub("\\.pdf$", ".png", file)
  image_write(img, out_file, format = "png", quality = 100)
}
```

## Batch Saving Multiple Plots

```{r}
#| label: saving-batch
#| echo: true
#| eval: false

library(tidyverse)

# Create tibble with data, plots, and titles
plot_data <- tibble(
  title = c("mtcars", "iris", "faithful"),
  data = list(mtcars, iris, faithful),
  plot = list(
    ggplot(mtcars, aes(wt, mpg)) +
      geom_point() +
      labs(title = "mtcars: Weight vs MPG"),
    ggplot(iris, aes(Sepal.Length, Sepal.Width, color = Species)) +
      geom_point() +
      labs(title = "iris: Sepal dimensions"),
    ggplot(faithful, aes(eruptions)) +
      geom_histogram(bins = 30) +
      labs(title = "faithful: Eruption duration")
  )
)

# Save all plots using iwalk
iwalk(plot_data$plot, ~ggsave(
  filename = paste0("figure_", plot_data$title[.y], ".pdf"),
  plot = .x,
  width = 7, height = 5
))

# Creates: figure_mtcars.pdf, figure_iris.pdf, figure_faithful.pdf
```

## File Organization

```{r}
#| label: saving-organization
#| echo: true
#| eval: false

# Good practice: separate directory
dir.create("figures", showWarnings = FALSE)

ggsave("figures/figure1.pdf", p1, width = 7, height = 5)
ggsave("figures/figure1.png", p1, width = 7, height = 5, dpi = 300)

# Save both vector and raster versions!
```

## Saving Base R Plots (and ALL Non-ggplot2 Graphics)

::: {.callout-important}
## dev.off() is the Universal Approach

The device approach works for **ALL** R plotting systems:

- Base R graphics
- ggplot2 (though ggsave() is easier)
- Grid graphics
- Custom plotting functions
:::

```{r}
#| label: saving-base-r
#| echo: true
#| eval: false

# For non-ggplot2 plots, use device functions
# ALWAYS works, regardless of plotting system
cairo_pdf("baseplot.pdf", width = 7, height = 5)
  plot(x, y)
  abline(lm(y ~ x))
  # Can have multiple plotting commands here
  points(x2, y2, col = "red")
  legend("topright", legend = c("Data", "Fit"), col = c("black", "blue"))
dev.off()  # Close device - file is now saved

# Or for PNG
png("baseplot.png", width = 7, height = 5,
    units = "in", res = 300, type = "cairo")
  plot(x, y)
  # Multiple commands work here too
  lines(lowess(x, y), col = "blue", lwd = 2)
dev.off()

# For lattice plots
library(lattice)
pdf("lattice_plot.pdf", width = 6, height = 4)
  print(xyplot(mpg ~ wt, data = mtcars))  # Note: print() needed for lattice
dev.off()
```

::: {.callout-tip}
## When to Use dev.off() vs ggsave()

**Use ggsave():**

- When working with ggplot2 objects
- Cleaner syntax
- No need to manage device lifecycle

**Use dev.off():**

- Base R plots
- Lattice plots
- Complex multi-plot layouts with par() or layout()
- When you need fine control over device settings
- When combining multiple plot types in one figure
:::

## Checking Output Quality

```{r}
#| label: saving-quality-check
#| echo: true
#| eval: false

# Save plot
ggsave("test.pdf", p, width = 7, height = 5)

# Check file size
file.info("test.pdf")$size / 1024  # Size in KB

# View at 100% zoom in PDF viewer
# Print at actual size to test
```

## Resolution Guidelines Reminder

| Purpose | Format | DPI |
|---------|--------|-----|
| Draft/screen | PNG | 72-150 |
| Presentation | PNG/PDF | 150-200 |
| Print journal | PDF/TIFF | 300-600 |
| High-quality journal | TIFF | 600-1200 |

## Recommendations

::: {.callout-tip}
## Best Practices

1. **Always use ggsave()** for ggplot2 (not manual devices)
2. **Always specify width, height, units**
3. **Use cairo_pdf** for PDF output
4. **Specify DPI** for all raster formats (≥300 for print)
5. **Save both PDF and PNG** versions
6. **Organize** figures in dedicated directory
7. **Test output** by printing at actual size
:::

## Complete Example

```{r}
#| label: saving-complete-example
#| echo: true
#| eval: false

# Create publication-quality plot
library(ggplot2)

p <- ggplot(mtcars, aes(wt, mpg, color = factor(cyl))) +
  geom_point(size = 3) +
  geom_smooth(method = "lm", se = FALSE) +
  scale_color_brewer(palette = "Set1", name = "Cylinders") +
  theme_classic(base_size = 11) +
  labs(x = "Weight (1000 lbs)", y = "Miles per Gallon",
       title = "Fuel Efficiency by Weight")

# Save for journal (vector)
ggsave("figures/mpg_analysis.pdf", p,
       width = 3.5, height = 3, units = "in",
       device = cairo_pdf)

# Save for presentation (raster)
ggsave("figures/mpg_analysis.png", p,
       width = 8, height = 6, units = "in",
       dpi = 300, type = "cairo")
```
